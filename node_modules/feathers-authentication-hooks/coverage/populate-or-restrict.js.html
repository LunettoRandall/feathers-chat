<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for populate-or-restrict.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="prettify.css" />
    <link rel="stylesheet" href="base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="index.html">All files</a> populate-or-restrict.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">50% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>24/48</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">44.74% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>17/38</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">25% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>2/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">51.06% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>24/47</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import errors from 'feathers-errors';
&nbsp;
/**
 * Populate the current user associated with the JWT
 */
const defaults = {
  userEndpoint: '/users',
  idField: '_id'
};
&nbsp;
export default function (options = <span class="branch-1 cbranch-no" title="branch not covered" >{}) {</span>
  return function (hook) {
    let id;
&nbsp;
    options = Object.assign({}, defaults, hook.app.get('auth'), options);
&nbsp;
    // If it's an after hook grab the id from the result
    <span class="missing-if-branch" title="if path not taken" >I</span>if (hook.type !== 'before') {
<span class="cstat-no" title="statement not covered" >      throw new Error(`The 'populateOrRestrict' hook should only be used as a 'before' hook.`);</span>
    }
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>i</span>f (hook.method !== 'find' &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >hook.method !== 'get') {
<span class="cstat-no" title="statement not covered" >      throw new Error(`'populateOrRestrict' should only be used in a find or get hook.`);</span>
    }
&nbsp;
    // If it was an internal call then skip this hook
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!hook.params.provider) {
<span class="cstat-no" title="statement not covered" >      return hook;</span>
    }
&nbsp;
    // If we don't have a payload we have to always use find instead of get because we must not return id queries that are unrestricted and we don't want the developer to have to add after hooks.
    let query = Object.assign({}, hook.params.query, options.restrict);
&nbsp;
    // Set provider as undefined so we avoid an infinite loop if this hook is
    // set on the resource we are requesting.
    const params = Object.assign({}, hook.params, { provider: undefined });
&nbsp;
    if (hook.id !== null &amp;&amp; hook.id !== undefined) {
      const id = {};
      id[options.idField] = hook.id;
      query = Object.assign(query, id);
    }
&nbsp;
    // Check to see if we have an id from a decoded JWT
    if (hook.params.payload) {
      id = hook.params.payload[options.idField];
    } else {
      <span class="missing-if-branch" title="if path not taken" >I</span>if (hook.result) {
<span class="cstat-no" title="statement not covered" >        return hook;</span>
      }
&nbsp;
      return this.find({ query }, params).then(results =&gt; {
        <span class="missing-if-branch" title="if path not taken" >I</span>i</span>f (h</span>ook.method === 'get' &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >Array.isArray(results) &amp;&amp; <span class="branch-2 cbranch-no" title="branch not covered" >results.length === 1) {
<span class="cstat-no" title="statement not covered" >          hook.result = results[0];</span>
<span class="cstat-no" title="statement not covered" >          return hook;</span>
        } else {
          hook.result = results;
          return hook;
        }
      }).catch(<span class="fstat-no" title="function not covered" >() =&gt; </span>{
<span class="cstat-no" title="statement not covered" >        throw new errors.NotFound(`No record found`);</span>
      });
    }
&nbsp;
    // If we didn't find an id then just pass through
    <span class="missing-if-branch" title="else path not taken" >E</span>if (id === undefined) {
      return Promise.resolve(hook);
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    return new Promise(<span class="fstat-no" title="function not covered" >function (</span>resolve) <span class="cstat-no" title="statement not covered" >{</span></span>
<span class="cstat-no" title="statement not covered" >      hook.app.service(options.userEndpoint).get(id, {}).then(<span class="fstat-no" title="function not covered" >user =&gt; </span>{</span>
        // attach the user to the hook for use in other hooks or services
<span class="cstat-no" title="statement not covered" >        hook.params.user = user;</span>
&nbsp;
        // If it's an after hook attach the user to the response
<span class="cstat-no" title="statement not covered" >        if (hook.result) {</span>
<span class="cstat-no" title="statement not covered" >          hook.result.data = Object.assign({}, user = !user.toJSON ? user : user.toJSON());</span>
&nbsp;
          // remove the id field from the root, it already exists inside the user object
<span class="cstat-no" title="statement not covered" >          delete hook.result[options.idField];</span>
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        return resolve(hook);</span>
      }).catch(<span class="fstat-no" title="function not covered" >() =&gt; </span>{
<span class="cstat-no" title="statement not covered" >        if (hook.result) {</span>
<span class="cstat-no" title="statement not covered" >          return hook;</span>
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        return this.find({ query }, params).then(<span class="fstat-no" title="function not covered" >results =&gt; </span>{</span>
<span class="cstat-no" title="statement not covered" >          if (hook.method === 'get' &amp;&amp; Array.isArray(results) &amp;&amp; results.length === 1) {</span>
<span class="cstat-no" title="statement not covered" >            hook.result = results[0];</span>
<span class="cstat-no" title="statement not covered" >            return hook;</span>
          } else {
<span class="cstat-no" title="statement not covered" >            hook.result = results;</span>
<span class="cstat-no" title="statement not covered" >            return hook;</span>
          }
        }).catch(<span class="fstat-no" title="function not covered" >() =&gt; </span>{
<span class="cstat-no" title="statement not covered" >          throw new errors.NotFound(`No record found`);</span>
        });
      });
    });
  };
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sat Apr 08 2017 09:47:29 GMT-0700 (PDT)
</div>
</div>
<script src="prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="sorter.js"></script>
</body>
</html>
